<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Reservation Calendar</title>
  <style>
    * {
      margin: 0; padding: 0; box-sizing: border-box;
      font-family: 'Poppins', sans-serif;
    }
    body {
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 40px;
      background: #f5f5f5;
      min-height: 100vh;
    }
    .wrapper {
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      max-width: 400px;
      width: 100%;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .current-date {
      font-size: 1.5rem;
      font-weight: 600;
    }
    .icons span {
      cursor: pointer;
      font-size: 1.8rem;
      user-select: none;
    }
    .calendar {
      margin-top: 20px;
    }
    ul {
      list-style: none;
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 5px;
    }
    .weeks li {
      text-align: center;
      font-weight: 600;
      font-size: 0.9rem;
      color: #555;
    }
    .days li {
      text-align: center;
      padding: 10px 0;
      border-radius: 6px;
      cursor: pointer;
      transition: 0.2s;
      font-size: 0.9rem;
    }
    .days li:hover {
      background: #eee;
    }
    .days li.active {
      background: #007bff;
      color: #fff;
    }
    .days li.inactive {
      color: #aaa;
    }
    .days li.no-chairs {
      background: #ff4d4d;
      color: #fff;
    }
    .days li.not-available {
      background: #ffa500;
      color: #fff;
    }
    .days li.closed {
      background: #888;
      color: #fff;
    }
    .days li.green {
      background: #28a745;
      color: #fff;
    }
    .days li.selected {
        background: #33ff00; /* Highlight color */
        color: #000000;
        font-weight: bold;
    }
    .days li.disabled {
  background: #ccc;
  color: #777;
  pointer-events: none; /* Disable clicking */
}

    .input-container, .message-container {
      margin-top: 20px;
    }
    select, input[type="time"], input[type="text"], input[type="tel"], input[type="email"], textarea {
      width: 100%;
      padding: 10px;
      margin-top: 5px;
      margin-bottom: 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
    }
    textarea {
      resize: vertical;
    }
    button {
      background: #007bff;
      color: #fff;
      border: none;
      padding: 10px;
      width: 100%;
      border-radius: 6px;
      font-size: 1rem;
      cursor: pointer;
      margin-top: 10px;
    }
    button:hover {
      background: #0056b3;
    }
    #back-btn {
      background: #ccc;
      color: #333;
      margin-bottom: 20px;
    }
    #back-btn:hover {
      background: #bbb;
    }
    #summary {
      margin: 15px 0;
      font-weight: 500;
      font-size: 1.1rem;
      color: #333;
    }
    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #007bff;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      animation: spin 1s linear infinite;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      display: none; /* Hidden by default */
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .hidden {
      display: none
    }
    
  </style>
</head>

<body>

<div class="wrapper" id="calendar-section">
    <div class="input-container" id="date-input">
        <label for="people">Number of People:</label>
        <select id="people">
          <option value="">Select</option>
        </select>
      </div>
  <header>
    <p class="current-date"></p>
    <div class="icons">
      <span id="prev">&#10094;</span>
      <span id="next">&#10095;</span>
    </div>
  </header>
  <div class="calendar">
    <ul class="weeks">
      <li>Sun</li><li>Mon</li><li>Tue</li><li>Wed</li><li>Thu</li><li>Fri</li><li>Sat</li>
    </ul>
    <ul class="days"></ul>
  </div>


  <div class="message-container" id="message-container">
    <p id="message"></p>
    <div id="time-input" style="display: none;">
      <label for="time">Select Time:</label>
      <input type="time" id="time" />
      <button id="process-btn" style="display: none;">Proceed to Form</button>
    </div>    
  </div>
</div>

<!-- Reservation Form Section -->
<div class="wrapper" id="form-section" style="display: none;">
  <div id="form-hide">
  <button id="back-btn">‚Üê Back to Calendar</button>
  <h2>Complete Your Reservation</h2>
  <p id="summary"></p>

  <form id="reservation-form">
    <input type="text" id="name" placeholder="Your Name" required><br>
    <input type="tel" id="phone" placeholder="Phone Number" required><br>
    <input type="email" id="email" placeholder="Email Address" required><br>
    <textarea id="notes" placeholder="Additional Notes"></textarea><br>
    <button type="submit" id="submit-btn">Submit Reservation</button>
    <div class="spinner" id="spinner"></div> <!-- Loading spinner -->
  </form>
  </div>
  <p id="form-message" class="hidden"></p> <!-- Message box -->
</div>

<script>
    const daysTag = document.querySelector(".days"),
          currentDate = document.querySelector(".current-date"),
          prevNextIcon = document.querySelectorAll(".icons span"),
          peopleInput = document.querySelector("#people"),
          messageContainer = document.querySelector("#message"),
          timeInputContainer = document.querySelector("#time-input"),
          timeInput = document.querySelector("#time"),
          processBtn = document.querySelector("#process-btn"),
          calendarSection = document.querySelector("#calendar-section"),
          formSection = document.querySelector("#form-section"),
          backBtn = document.querySelector("#back-btn"),
          reservationForm = document.querySelector("#reservation-form"),
          summary = document.querySelector("#summary");

    let date = new Date(),
        currYear = date.getFullYear(),
        currMonth = date.getMonth();

    const months = ["January", "February", "March", "April", "May", "June", "July",
      "August", "September", "October", "November", "December"];

    let availableDays = {
      noChairs: [],
      remainingChairs: [],
      closedDays: []  // Track closed days
    };

    let selectedDate = "";
    let selectedTime = "";
    let selectedPeople = 1;  // To store the selected number of people

    const fetchAvailableDays = async () => {
      try {
        const response = await fetch('http://localhost:3000/api/v1/reservations/available-days');
        const data = await response.json();
        availableDays.noChairs = data.noChairs || [];
        availableDays.remainingChairs = data.remainingChairs || [];
      } catch (error) {
        console.error('Error fetching available days:', error);
      }
    };

    const fetchScheduleData = async () => {
      try {
        const scheduleResponse = await fetch('http://localhost:3000/api/v1/schedule');
        const scheduleData = await scheduleResponse.json();
        availableDays.closedDays = scheduleData.filter(item => item.status === 'close').map(item => ({
          date: item.date,
          message: item.message || "No special message available"
        }));
      } catch (error) {
        console.error('Error fetching schedule data:', error);
      }
    };

    const renderCalendar = () => {
  let firstDayofMonth = new Date(currYear, currMonth, 1).getDay(),
      lastDateofMonth = new Date(currYear, currMonth + 1, 0).getDate(),
      lastDayofMonth = new Date(currYear, currMonth, lastDateofMonth).getDay(),
      lastDateofLastMonth = new Date(currYear, currMonth, 0).getDate();

  let liTag = "";

  // Get today's date to compare with the days of the current month
  const today = new Date();
  const todayYear = today.getFullYear();
  const todayMonth = today.getMonth();
  const todayDate = today.getDate();

  // Loop through the previous month's dates
  for (let i = firstDayofMonth; i > 0; i--) {
    liTag += `<li class="inactive">${lastDateofLastMonth - i + 1}</li>`;
  }

  // Loop through the current month's dates
  for (let i = 1; i <= lastDateofMonth; i++) {
    let isToday = i === todayDate && currMonth === todayMonth && currYear === todayYear ? "active" : "",
        currentDateString = `${currYear}-${(currMonth + 1).toString().padStart(2, '0')}-${i.toString().padStart(2, '0')}`,
        status = "green";  // Default to green for available days

    // Check if the day is in the past
    const currentDate = new Date(currYear, currMonth, i);
    const isPastDay = currentDate.setHours(0, 0, 0, 0) < today.setHours(0, 0, 0, 0);

    // If it's a past day, disable it
    if (isPastDay) {
      status = "disabled";  // Set the class for disabled past days
    }
    // Check if the date is closed
    else if (availableDays.closedDays.some(item => item.date === currentDateString)) {
      status = "closed";
    } else if (availableDays.noChairs.includes(currentDateString)) {
      status = "no-chairs";
    } else {
      let remaining = availableDays.remainingChairs.find(item => item.date === currentDateString);
      if (remaining && peopleInput.value && peopleInput.value > remaining.remainingChairs) {
        status = "not-available";
      }
    }

    // Add the 'selected' class if the day is the previously selected day
    let selectedClass = currentDateString === selectedDate ? "selected" : "";
    liTag += `<li class="${isToday} ${status} ${selectedClass}" data-date="${currentDateString}">${i}</li>`;
  }

  // Loop through the next month's dates (fill in empty cells)
  for (let i = lastDayofMonth; i < 6; i++) {
    liTag += `<li class="inactive">${i - lastDayofMonth + 1}</li>`;
  }

  currentDate.innerText = `${months[currMonth]} ${currYear}`;
  daysTag.innerHTML = liTag;
};



// Event listener for day click
document.addEventListener("click", (e) => {
  if (e.target && e.target.tagName === "LI") {
    const clickedDate = e.target.getAttribute("data-date");
    const clickedDay = e.target.classList.contains("green");  // Check if clicked day is green (available)

    if (clickedDay) {
      // Handle available date selection (green days)
      selectedDate = clickedDate;
      const formattedDate = formatDate(selectedDate);
      messageContainer.innerHTML = `Selected Date: <strong>${formattedDate}</strong><br> Please select a time:`;
      timeInputContainer.style.display = "block";
      processBtn.style.display = "none";  // Hide proceed button until time is selected
    } else {
      // Handle special cases (closed, no chairs, not available)
      const closedDay = availableDays.closedDays.find(item => item.date === clickedDate);
      if (closedDay) {
        messageContainer.innerHTML = `Sorry, the date <strong>${formatDate(clickedDate)}</strong> is closed.<br>${closedDay.message || "No special message available"}`;
      } else if (availableDays.noChairs.includes(clickedDate)) {
        messageContainer.innerHTML = `Sorry, the date <strong>${formatDate(clickedDate)}</strong> has no available space.`;
      } else if (availableDays.remainingChairs.find(item => item.date === clickedDate && item.remainingChairs <= 0)) {
        messageContainer.innerHTML = `Sorry, the date <strong>${formatDate(clickedDate)}</strong> is not available for ${selectedPeople} people.`;
      }
      timeInputContainer.style.display = "none";  // Hide time selection
    }
  }
});


    prevNextIcon.forEach(icon => {
      icon.addEventListener("click", () => {
        currMonth = icon.id === "prev" ? currMonth - 1 : currMonth + 1;
        if (currMonth < 0 || currMonth > 11) {
          date = new Date(currYear, currMonth, new Date().getDate());
          currYear = date.getFullYear();
          currMonth = date.getMonth();
        } else {
          date = new Date();
        }
        renderCalendar();
      });
    });

    // Create the number of people options
// Create the number of people options
for (let i = 1; i <= 20; i++) {
  const option = document.createElement("option");
  option.value = i;
  option.text = i;

  // Set the default option to 1
  if (i === 1) {
    option.selected = true;
  }

  peopleInput.appendChild(option);
}

    // Event listener for when the user selects number of people
peopleInput.addEventListener("change", () => {
  selectedPeople = parseInt(peopleInput.value);
  renderCalendar();  // Re-render the calendar
});

    // Format selected date for displaying in the form
    function formatDate(dateString) {
      const options = { day: '2-digit', month: '2-digit', year: 'numeric' };
      return new Date(dateString).toLocaleDateString('en-GB', options); // DD/MM/YYYY
    }

    document.addEventListener("click", (e) => {
  if (e.target && e.target.tagName === "LI") {
    const clickedDate = e.target.getAttribute("data-date");
    const clickedDay = e.target.classList.contains("green");  // Check if clicked day is green (available)

    if (clickedDay) {
      // Handle available date selection (green days)
      selectedDate = clickedDate;
      const formattedDate = formatDate(selectedDate); // Format date before displaying
      messageContainer.innerHTML = `Selected Date: <strong>${formattedDate}</strong><br> Please select a time:`;
      timeInputContainer.style.display = "block";
      processBtn.style.display = "none"; // Hide proceed button until time is selected
      renderCalendar();  // Re-render the calendar to update the selected date color
    } else {
      // Handle special cases (closed, no chairs, not available)
      const closedDay = availableDays.closedDays.find(item => item.date === clickedDate);
      if (closedDay) {
        messageContainer.innerHTML = `Sorry, the date <strong>${formatDate(clickedDate)}</strong> is closed.<br>${closedDay.message || "No special message available"}`;
      } else if (availableDays.noChairs.includes(clickedDate)) {
        messageContainer.innerHTML = `Sorry, the date <strong>${formatDate(clickedDate)}</strong> has no available space.`;
      } else if (availableDays.remainingChairs.find(item => item.date === clickedDate && item.remainingChairs <= 0)) {
        messageContainer.innerHTML = `Sorry, the date <strong>${formatDate(clickedDate)}</strong> is not available for ${selectedPeople} people.`;
      }
      timeInputContainer.style.display = "none"; // Hide time selection
    }
  }
});


// When the time is selected, show the process button
timeInput.addEventListener("input", () => {
  selectedTime = timeInput.value; // Update selectedTime whenever a time is selected
  const minTime = "09:00";
  const maxTime = "22:00";

  if (selectedTime >= minTime && selectedTime <= maxTime) {
    processBtn.style.display = "block"; // Show the button if valid time
  } else {
    processBtn.style.display = "none"; // Hide the button if invalid time
  }
});

// When the user clicks on the "Proceed to Form" button
processBtn.addEventListener("click", () => {
  // Make sure selectedTime is updated when the button is clicked
  if (!selectedTime) {
    messageContainer.innerHTML = "Please select a time before proceeding.";
    return;
  }
  backBtn.addEventListener("click", () => {
      formSection.style.display = "none";
      calendarSection.style.display = "block";
    });

  // Include selectedTime in the summary, and format selectedDate
  summary.innerHTML = `You have selected <strong>${selectedPeople}</strong> people for the date <strong>${formatDate(selectedDate)}</strong> at <strong>${selectedTime}</strong>.`;
  formSection.style.display = "block";
  calendarSection.style.display = "none";
});

// Handle form submission
reservationForm.addEventListener("submit", async (e) => {
  e.preventDefault();
    // Disable all fields and the button
    const submitBtn = document.getElementById("submit-btn");
  const spinner = document.getElementById("spinner");
  submitBtn.disabled = true;
  submitBtn.style.background = '#ccc';
  spinner.style.display = 'block'; // Show the spinner

  const reservationData = {
    name: document.getElementById("name").value,
    phone: document.getElementById("phone").value,
    email: document.getElementById("email").value,
    peopleCount: selectedPeople,
    date: selectedDate, // Ensure selectedDate is in correct format
    time: selectedTime,
    notes: document.getElementById("notes").value,
  };

  try {
    const response = await fetch('http://localhost:3000/api/v1/reservations/', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(reservationData)
    });

       if (response.ok) {
      // Hide form, show success message
      document.getElementById("form-hide").style.display = "none";
      document.getElementById("form-message").classList.remove('hidden');
      document.getElementById("form-message").innerHTML = 'Reservation successful! Please check your email for confirmation.';
    } else {
      // Show error message
      const errorData = await response.json();
      document.getElementById("form-message").classList.remove('hidden');
      document.getElementById("form-message").innerHTML = `Error: ${errorData.message || 'Something went wrong. Please try again.'}`;
    }
  } catch (error) {
    // Handle network error
    document.getElementById("form-message").classList.remove('hidden');
    document.getElementById("form-message").innerHTML = 'Server error. Please try again later.';
  } finally {
    spinner.style.display = 'none'; // Hide spinner
  }
});


    // Initialize everything
    fetchAvailableDays().then(() => {
      renderCalendar();
    });
    fetchScheduleData().then(() => {
      renderCalendar();
    });
</script>

</body>
</html>
